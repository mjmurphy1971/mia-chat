{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/mjmur/mia-assistant/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport OpenAI from \"openai\";\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n\r\n    const messages = Array.isArray(body?.messages) ? body.messages : [];\r\n\r\n    // Prefer the most recent USER message (safer than assuming last item is user)\r\n    const lastUserMsg = [...messages]\r\n      .reverse()\r\n      .find((m: any) => (m?.role || \"\").toLowerCase() === \"user\");\r\n\r\n    const lastUserText = (lastUserMsg?.content ?? \"\")\r\n      .toString()\r\n      .toLowerCase()\r\n      .trim();\r\n\r\n    // Env\r\n    const schedulingLink = process.env.SCHEDULING_LINK_15_MIN;\r\n    const resumePdfUrl = process.env.RESUME_PDF_URL;\r\n\r\n    const systemPrompt =\r\n      process.env.MIA_SYSTEM_PROMPT ??\r\n      \"You are Mia, Mary Murphy's practical, warm, slightly skeptical professional assistant. Be concise and action-oriented.\";\r\n\r\n    const model = process.env.OPENAI_MODEL ?? \"gpt-4o-mini\";\r\n\r\n    // 0) Resume intent (fast-path)\r\n    if (\r\n      resumePdfUrl &&\r\n      (lastUserText.includes(\"resume\") ||\r\n        lastUserText.includes(\"cv\") ||\r\n        lastUserText.includes(\"pdf\") ||\r\n        lastUserText.includes(\"download\") ||\r\n        lastUserText.includes(\"printed copy\") ||\r\n        lastUserText.includes(\"print\"))\r\n    ) {\r\n      return NextResponse.json({\r\n        reply: `You can download Mary’s resume here (PDF): ${resumePdfUrl}`,\r\n      });\r\n    }\r\n\r\n    // 1) Scheduling intent (fast-path)\r\n    if (\r\n      schedulingLink &&\r\n      (lastUserText.includes(\"schedule\") || lastUserText.includes(\"scheduling\"))\r\n    ) {\r\n      return NextResponse.json({\r\n        reply: `You can schedule time with Mary here: ${schedulingLink}`,\r\n      });\r\n    }\r\n\r\n    // --- LinkedIn refinement loop (C.2 Option 2) ---\r\n\r\n    const isLinkedInIntent =\r\n      lastUserText.includes(\"linkedin\") ||\r\n      lastUserText.includes(\"post\") ||\r\n      lastUserText.includes(\"thought leadership\");\r\n\r\n    const isRefineIntent =\r\n      lastUserText.includes(\"shorter\") ||\r\n      lastUserText.includes(\"shorten\") ||\r\n      lastUserText.includes(\"punchier\") ||\r\n      lastUserText.includes(\"bolder\") ||\r\n      lastUserText.includes(\"more executive\") ||\r\n      lastUserText.includes(\"more senior\") ||\r\n      lastUserText.includes(\"tighten\") ||\r\n      lastUserText.includes(\"rewrite\") ||\r\n      lastUserText.includes(\"revise\") ||\r\n      lastUserText.includes(\"edit\") ||\r\n      lastUserText.includes(\"improve\") ||\r\n      lastUserText.includes(\"variants\") ||\r\n      lastUserText.includes(\"3 versions\") ||\r\n      lastUserText.includes(\"three versions\");\r\n\r\n    // Grab the most recent assistant message as the \"draft\" if present\r\n    const lastAssistantText = [...messages]\r\n      .reverse()\r\n      .find((m: any) => (m?.role || \"\").toLowerCase() === \"assistant\")\r\n      ?.content;\r\n\r\n    // If user is asking to refine but we don't have a draft, ask for it\r\n    if (isRefineIntent && !lastAssistantText) {\r\n      return NextResponse.json({\r\n        reply:\r\n          \"Sure — paste the LinkedIn draft you want to refine, and tell me ONE preference: (1) shorter, (2) more executive, or (3) 3 variants.\",\r\n      });\r\n    }\r\n\r\n    // If user is asking to refine a LinkedIn post, rewrite the last assistant draft\r\n    if (isLinkedInIntent && isRefineIntent && lastAssistantText) {\r\n      const refinePrompt = `\r\nYou are Mia, Mary Murphy’s practical, warm, slightly skeptical professional assistant.\r\n\r\nTASK:\r\nRewrite the LinkedIn post draft below based on the user's request.\r\n\r\nRULES:\r\n- Keep it LinkedIn-ready\r\n- Keep the core meaning\r\n- Make it clean, concise, and scannable\r\n- Add 3–6 relevant hashtags at the end\r\n- Do not invent metrics or claims\r\n\r\nUSER REQUEST:\r\n\"${lastUserText}\"\r\n\r\nDRAFT TO REFINE:\r\n\"\"\"${lastAssistantText}\"\"\"\r\n      `.trim();\r\n\r\n      const completion = await openai.chat.completions.create({\r\n        model,\r\n        temperature: 0.6,\r\n        messages: [\r\n          { role: \"system\", content: systemPrompt },\r\n          { role: \"user\", content: refinePrompt },\r\n        ],\r\n      });\r\n\r\n      const revised =\r\n        completion.choices?.[0]?.message?.content?.trim() || \"(No reply)\";\r\n\r\n      return NextResponse.json({ reply: revised });\r\n    }\r\n\r\n    // If they want LinkedIn help/refinement, use a focused prompt\r\n    if (isLinkedInIntent || isRefineIntent) {\r\n      const refineInstruction = isRefineIntent\r\n        ? `Refinement request from user: \"${lastUserText}\".`\r\n        : `Create a new LinkedIn post based on user request: \"${lastUserText}\".`;\r\n\r\n      const draftContext = lastAssistantText\r\n        ? `Here is the current draft to refine:\\n\\n${lastAssistantText}\\n\\n`\r\n        : \"\";\r\n\r\n      const userMsg = `${draftContext}${refineInstruction}\r\n\r\nRules:\r\n- Keep it professional and readable (no hype).\r\n- Use short paragraphs.\r\n- End with a gentle question or CTA.\r\n- Avoid excessive emojis (0–2 max).\r\n- If user asked for \"3 variants\", return 3 clearly labeled options.`;\r\n\r\n      try {\r\n        const result = await openai.chat.completions.create({\r\n          model,\r\n          messages: [\r\n            { role: \"system\", content: systemPrompt },\r\n            { role: \"user\", content: userMsg },\r\n          ],\r\n          temperature: 0.7,\r\n        });\r\n\r\n        const text =\r\n          result.choices?.[0]?.message?.content?.trim() ||\r\n          \"I didn’t get a response back—try again.\";\r\n\r\n        return NextResponse.json({ reply: text });\r\n      } catch (e: any) {\r\n        return NextResponse.json(\r\n          { error: \"OpenAI call failed\", details: e?.message || String(e) },\r\n          { status: 500 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // --- end LinkedIn refinement loop ---\r\n\r\n    // 2) AI response (everything else)\r\n    if (!process.env.OPENAI_API_KEY) {\r\n      return NextResponse.json(\r\n        { error: \"Missing OPENAI_API_KEY in .env.local\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const completion = await openai.chat.completions.create({\r\n      model,\r\n      temperature: 0.7,\r\n      messages: [\r\n        { role: \"system\", content: systemPrompt },\r\n        // pass through the conversation from the UI\r\n        ...messages.map((m: any) => ({\r\n          role: (m?.role || \"\").toLowerCase() === \"assistant\" ? \"assistant\" : \"user\",\r\n          content: (m?.content ?? \"\").toString(),\r\n        })),\r\n      ],\r\n    });\r\n\r\n    const reply = completion.choices?.[0]?.message?.content?.trim() || \"(No reply)\";\r\n\r\n    return NextResponse.json({ reply });\r\n  } catch (err: any) {\r\n    return NextResponse.json(\r\n      { error: \"Failed to process request\", details: err?.message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}